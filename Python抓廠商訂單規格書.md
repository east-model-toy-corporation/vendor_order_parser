以下是「究極進化版 ERP 合併標準化工具」的規格書。內容涵蓋目標、輸入/輸出、欄位定義、流程、匯率邏輯、GUI 互動、錯誤處理、相依環境與可擴充性。

一、專案概要
- 名稱：究極進化版 ERP 合併標準化工具
- 目的：讓使用者從一份或多份 Excel 訂單/結單檔匯入，經自動欄位對映、日期與幣別處理、台幣換算後，輸出為固定 ERP 欄位結構的 Excel 檔，供後續上傳雲端或匯入 ERP。
- 執行環境：Windows（優先）、Python 3.10.10
- GUI：tkinter
- 主要套件：pandas、openpyxl、requests、tkinter（標準庫）

二、輸入與輸出
1) 輸入
- 檔案型態：.xlsx 或 .xls
- 檔案數量：使用者一次可選擇一份或多份（不限數量）
- 工作表：每份來源檔僅讀取第一個 Sheet
- 來源欄位：不固定，透過關鍵字/正則模糊對映到目標欄位。未被對映的來源欄位一律丟棄
- 商品相關資訊只需要"東海成本"及"東海售價"有值的商品

2) 輸出
- 檔案型態：Excel .xlsx
- 檔名：預設「究極進化版用.xlsx」（可由使用者調整）
- 工作表：單一 Sheet，名稱「ERP」
- 欄位結構：固定 31 欄，順序嚴格如下
  1. ERP
  2. GD
  3. 平台前導
  4. 寄件廠商
  5. 暫代條碼
  6. 型號
  7. 預計發售月份
  8. 上架日期
  9. 結單日期
  10. 條碼
  11. 品名
  12. 品牌
  13. 國際條碼
  14. 起始進價
  15. 建議售價
  16. 廠商
  17. 類1
  18. 類2
  19. 類3
  20. 類4
  21. 顏色
  22. 季別
  23. 尺1
  24. 尺寸名稱
  25. 特價
  26. 原價
  27. 原價幣別
  28. 批價
  29. 建檔
  30. 備註
  31. 規格

三、欄位來源與填值規則
- 不需 mapping（固定留空）：ERP、GD、平台前導、暫代條碼、國際條碼、類2、類3、類4、顏色、季別、特價
- 固定值：
  - 尺1：固定填入「F」
  - 尺寸名稱：固定填入「F」
  - 上架日期：執行程式當天日期，格式 YYYY/MM/DD
- 由來源欄位 mapping 或邏輯推導：
  - 寄件廠商（D）：來源欄位名稱包含「廠商/代理/供應」等關鍵字
  - 型號（F）：填入「國際條碼」值（同條碼）
  - 預計發售月份（G）：來源含「發售月/預定到貨/預計上市/預定月份」等欄位；轉為 YYYYMM（六位數），若來源格式為 YYYY-MM 或 YYYY/MM 或含中文年月，需解析後組裝
  - 結單日期（I）：來源含「結單/截止/截單」等；輸出格式 YYYY/MM/DD；若來源為 Excel 日期或文字日期（含 . - / 年月日），需解析正規化
  - 條碼（J）：填入「國際條碼」值
  - 品名（K）：來源欄位名稱包含「品名/名稱/商品名/品項/商品」
  - 品牌（L）：依品名推導品牌代號；若暫無對照表，預設留空（可擴充）
  - 起始進價（N）：來源含「東海成本」
  - 建議售價（O）：來源含「東海售價」
  - 廠商（P）：依品名推導廠商代號；若暫無對照表，預設留空（可擴充）
  - 類1（Q）：依品名推導廠商代號；若暫無對照表，預設留空（可擴充）
  - 原價（Z）：來源含「原價/定價/售價」
  - 原價幣別（AA）：來源含「幣別/貨幣/JPY/USD/TWD/日幣/美元」等；若未明確，預設留空
  - 批價（AB）：預設留空
  - 建檔（AC）：來源含「建立/建立時間/建檔/編號」等，未匹配則留空
  - 備註（AD）：來源含「備註/備考/附註」
  - 規格（AE）：來源含「規格/說明/描述」

補充：
- 型號（F）與 條碼（J）均取同一來源「國際條碼」欄位值
- 國際條碼（M）為留空，僅作為目標欄位中的預留欄位
- 品牌/廠商/類1 依品名推導的代碼如需精準，需後續提供對照表（可外掛配置 JSON/CSV）

四、幣別與匯率
1) 幣別來源與推斷
- 優先從來源「原價幣別（AB）」對映之欄位
- 若無法對映，預設為 TWD
- 可接受的幣別代碼：TWD、JPY、USD（如來源為中文，如「日幣/美金」可映射為 JPY/USD）

2) 換算邏輯
- 需換算的欄位：暫不需要
- 規則：
  - 若幣別為 JPY：台幣金額 = 原金額 × 當日台銀「日圓即期賣出」匯率
  - 若幣別為 USD：台幣金額 = 原金額 × 當日台銀「美元即期賣出」匯率
  - 若幣別為 TWD：維持數值（四捨五入到小數2位）
- 匯率來源：
  - 連線成功：台灣銀行即期賣出匯率 CSV（https://rate.bot.com.tw/xrt/flcsv/0/day）
  - 連線失敗：tkinter 對話框請使用者手動輸入 USD 與 JPY 的匯率
- 匯率日期與來源：不另設欄位儲存；如後續需要，可新增 rate_date、rate_source 欄位

五、GUI 操作流程
1) 啟動程式後，跳出檔案選擇對話框
- 可多選 .xlsx 或 .xls 檔案
2) 選完來源後，跳出另存新檔對話框
- 預設檔名：究極進化版用.xlsx（可修改）
3) 程式自動嘗試抓取匯率
- 若成功，直接進行處理
- 若失敗，跳出兩個輸入框，請使用者依序輸入 USD、JPY 匯率（即期賣出）
4) 處理完成後跳出完成訊息框，顯示輸出路徑

六、資料處理與對映方式
- 僅讀每份 Excel 的第一個 Sheet
- 先偵測來源欄位名稱，透過關鍵字/正則做軟對映
- 逐列構建目標列資料，未對映欄位填空，固定值欄位填預設值
- 日期正規化：
  - 結單日期支持 Excel 日期型別、YYYY/MM/DD、YYYY-MM-DD、YYYY.MM.DD、YYYY年M月D日等，輸出統一 YYYY/MM/DD
  - 預計發售月份支持 YYYYMM、YYYY/MM、YYYY-MM、YYYY年M月，輸出統一 YYYYMM
- 來源欄位超過目標欄位者一律丟棄，不附加到輸出尾端
- 空白列（全欄皆空）跳過

七、錯誤處理與提醒
- 未選擇來源檔：終止並顯示訊息
- 未選擇輸出檔：終止並顯示訊息
- 匯率 API 失敗：跳對話框要求手動輸入；若使用者取消或輸入非法（空/非數值），則中止並顯示錯誤
- 單一來源表為空或全部為空白列：跳過該檔
- 對映不到關鍵欄位時照規則留空；建議在 console/日誌列印提示（可選）

八、效能與限制
- 預期單次處理數千列資料在數秒至數十秒內完成（視機器與檔案大小）
- pandas/openpyxl 的記憶體占用隨資料量線性增加
- 僅支援第一個 Sheet；如需多 Sheet，後續可擴充

九、安全與隱私
- 所有處理在本機進行
- 僅在需要時對外連線台銀網站抓取匯率；無其他資料上傳
- 無憑證與金鑰管理

十、檔案與程式結構（建議）
- 單檔方案：main.py（包含 GUI、匯率、mapping、寫檔）
- 模組化方案（可選）：
  - main.py：流程統籌與 GUI
  - mapping.py：欄位對映與資料清洗
  - rates.py：匯率取得與手動輸入
  - export.py：Excel 輸出與樣式
- 設定檔（可選）：brand_vendor_map.json（品牌/廠商/類1 對照表，日後擴充）

十一、可擴充性
- 品牌/廠商/類1 對照：允許外掛 CSV/JSON 對照表規則或正則規則
- 匯率欄位：可在輸出新增 rate_date 與 rate_source
- 欄位驗證：可加上數值範圍、必填驗證（如條碼、品名）
- 多語對映：擴充更多關鍵字（例如 EN 欄名）
- 多 Sheet 支援：改為自動偵測「資料列最多的 Sheet」

十二、驗收標準
- 手動選擇 1~N 份 Excel，成功合併輸出為「究極進化版用.xlsx」
- 輸出檔之欄位順序、名稱與數量完全符合 31 欄規格
- 上架日期為執行當天日期（YYYY/MM/DD）
- 預計發售月份輸出為 YYYYMM（若來源能解析）
- 結單日期輸出為 YYYY/MM/DD（若來源能解析）
- 金額欄位（起始進價、建議售價、原價、批價）若幣別為 JPY/USD，依匯率換算為 TWD 並四捨五入至小數2位；幣別缺失時預設 TWD
- 未匹配之來源欄位不出現在輸出
- 匯率 API 無法取得時，能正常使用手動輸入流程完成輸出

十三、使用者操作說明（簡表）
- 打開程式 → 選擇多個 Excel 檔 → 指定輸出檔名與位置 →（需要時）手動輸入 USD/JPY 匯率 → 完成並查看輸出檔

十四、開發執行步驟
- 步驟 1：環境設定與主體框架：建立主程式入口、GUI 介面（檔案選擇、儲存、訊息框）以及主流程控制函數。此階段先不實現複雜的資料處理邏輯。
- 步驟 2：匯率處理模組：專注於實作匯率功能。包括從台灣銀行網站爬取匯率，以及在失敗時跳出 tkinter 對話框讓使用者手動輸入。
- 步驟 3：核心資料讀取與合併：實作讀取多個 Excel 檔案，並將它們的第一個工作表用 pandas 合併成一個大的 DataFrame。
- 步驟 4：欄位對映與資料清洗：這是最複雜的部分。實作模糊關鍵字對映，將來源欄位對應到目標欄位。處理固定值、日期格式化、資料篩選等。
- 步驟 5：幣別判斷與金額換算：根據「原價幣別」欄位，對指定的金額欄位進行匯率換算。
- 步驟 6：最終輸出：將處理完成的 DataFrame 按照規格書指定的 31 個欄位順序排列，並寫入新的 Excel 檔案。
- 步驟 7：錯誤處理與優化：完善各類錯誤處理機制，並進行程式碼的整理與優化。