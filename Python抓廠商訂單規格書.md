以下是「究極進化版 ERP 合併標準化工具」的規格書。內容涵蓋目標、輸入/輸出、欄位定義、流程、GUI 互動、錯誤處理、相依環境與可擴充性。

一、專案概要
- 名稱：究極進化版 ERP 合併標準化工具
- 目的：讓使用者透過 GUI 介面，選擇多份 Excel 訂單檔案，由 AI 進行智慧資料提取，再由 Python 程式將提取後的資料精準對映，最終輸出為統一格式的 Excel 檔案，供後續上傳 ERP 系統。
- 執行環境：Windows（優先）、Python 3.10+
- GUI：tkinter
- 主要套件：pandas、openpyxl、openai、tkinter（標準庫）

二、輸入與輸出 (精修)

1) 輸入
- **來源檔案**：
  - 檔案型態：.xlsx 或 .xls
  - 檔案數量：使用者一次可選擇 1 至 10 份檔案（程式限制最多 10）。
  - 工作表：每份來源檔僅讀取第一個 Sheet 的全部內容，不進行任何預處理。
- **設定檔案**：
  - `廠商名單.xlsx`：與主程式放在同一目錄，包含一個名為「寄件廠商」的欄位，用於讓 AI 精準匹配。
  - **`品牌對照資料查詢.xlsx` (規則更新)**：與主程式放在同一目錄。此檔案為品牌比對的核心，程式會讀取以下欄位：
    - **A欄**: 用於比對的品牌**關鍵字**。
    - **B欄**: 對應的**品牌代碼**，將填入最終輸出的「品牌」欄。
    - **D欄**: 對應的**顯示名稱**，將用於組合最終的「品名」。

2) 輸出
- **中介資料（除錯用，可關閉）**：
  - `raw_data.json`：由 AI 提取並經過結構化處理後的 JSON。注意：目前程式預設不主動儲存中介 JSON（已註解），可在偵錯時啟用以檢視 AI 回傳。
- **最終產出**：
  - 檔案型態：Excel .xlsx
  - 檔名：預設 `究極進化版用.xlsx`（使用者可在 GUI 的「開始處理」時指定儲存路徑與檔名）。
  - 工作表：單一 Sheet，名稱 `ERP`
  - 欄位結構：固定 27 欄，順序與名稱必須嚴格符合規定。

三、處理流程 (重大更新)

**第一階段：AI 資料提取**

此階段的目標是讓 AI 從原始、非結構化的 Excel 資料中，辨識並提取出有用的資訊。

1.  **品牌掃描與模式判斷 (新增)**：在讀取 Excel 檔案後，程式會**優先**掃描整個檔案的內容，並與 `品牌對照資料查詢.xlsx` 的品牌列表進行比對，以判斷此檔案屬於「單一品牌檔案」還是「多品牌檔案」。此結果會影響第二階段的品牌指派邏輯。
2.  **讀取資料**：Python 程式讀取使用者選擇的 Excel 檔案，將其完整內容轉換為 CSV 格式以供 AI 做解析。
3.  **準備提示 (Prompt)**：程式將結合 CSV 內容與相關設定檔，產生一個詳細指令給 AI，要求提取下列欄位：
    - `寄件廠商`：從 `廠商名單.xlsx` 找完全符合的廠商名稱。
    - `國際條碼`：關鍵字 ['國際條碼', 'jan code', '條碼']。
    - `貨號`：關鍵字 ['sku', '貨號', '商品貨號']。
    - `品名`：關鍵字 ['品名', '商品名', '品項', '商品', '中文品名']。
    - `結單日期`：優先從檔名擷取（例如檔名開頭為 `0126結單`，則擷取 `0126`）；若檔名無法擷取，再於內容中搜尋關鍵字 ['結單日', '結單日期', '訂購截止日', '訂單截止日', '預定截止日', '最後回單日']。
    - `預計發售月份`：關鍵字 ['發售日', '預定到貨', '預計上市日', '發貨日']。
    - `備註`：關鍵字 ['備註', '備考', '附註', '註']。
    - `起始進價`：關鍵字 ['東海成本']。
    - `建議售價`：關鍵字 ['東海售價']。
    - **`偵測到的品牌` (規則更新)**：指令要求 AI 分析商品所有欄位，並從品牌列表中找出最精確的**製造商**。AI 已被特別指導，當製造商（如 `FREEing`）和發行商（如 `Good Smile Company`）同時被提及時，應**優先選擇製造商**。
4.  **AI 回傳格式**：AI 應回傳結構化 JSON，包含 `global_info` 與 `products` 陣列，供第二階段使用。

**第二階段：Python 格式化與輸出**

此階段的目標是讀取 AI 回傳的 JSON，進行嚴格的驗證、格式化，並將資料填入 30 欄 ERP 格式。

1.  **價格資料驗證過濾 (新增)**：程式會先逐一檢查 AI 回傳的每一筆商品。**只有當 `起始進價` 和 `建議售價` 兩個欄位都存在且有值時**，該商品才會被保留。任何缺少價格的商品都會在此階段被程式**可靠地過濾**，確保資料完整性。
2.  **欄位對映與品牌指派 (規則更新)**：
    *   將 JSON 中的欄位對應填入 30 個 ERP 欄位。
    *   **`品牌` 欄位的決定**：採用多層次優先級 (AI判斷 > 單一品牌檔案備援 > 預設公式)，以決定最終寫入「品牌」欄位的**品牌代碼 (B欄)**。
    *   **`品名` 欄位的組合 (新增規則)**：
        1.  在決定了商品的品牌後，程式會去查詢該品牌在 `品牌對照資料查詢.xlsx` 中的 **D欄(顯示名稱)**。
        2.  **如果 D欄有內容**，則最終的「品名」會被組合為：`D欄顯示名稱 原始品名` (以空格分隔)。
        3.  **如果 D欄為空白**，則「品名」保持為 AI 提取的原始品名，**不加上任何前綴**。
3.  **日期與月份正規化**：
    - `預計發售月份`：會正規化為 `YYYYMM`（例如 `202511`）。不論原始儲存格為 Excel 日期（Timestamp）、或顯示為 `2025.11`、或字串含時間 `2025-11-01 00:00:00`，程式會先以 `pandas.to_datetime` 解析，再取年與月份。
    - `上架日期`：自動填入執行當天日期，格式 `YYYY/MM/DD`。
    - `結單日期`：程式會以 `YYYY/MM/DD` 格式輸出；當來源為檔名（如 `0126`）時，會選擇「最接近且大於今天」的那個日期（可能是當年度或下一年度），若 AI 也回傳結單日期，且檔名解析成功，檔名日期會優先覆蓋 AI 的值。
    - `結單日期` 的最終調整規則（週末處理）：
        1. 如果原始結單日期為週末（週六/週日），先向前移動到最近的前一個平日（週一到週五），再往前減 1 天，最後若結果仍非平日則再向前移到前一個平日。
        2. 若原始結單日期為平日，則先往前減 1 天；如果該結果落在週末，則再往前移到最近的平日。
       （備註：目前只把週末視為「非上班日」，未納入台灣國定假日。如需完整國定假日支援，可引入 `holidays` 或 `workalendar` 等套件並在規則中考量。）
4.  **合併輸出**：將所有處理後的商品資料合併成一個 DataFrame，並輸出為 `ERP` 工作表的 Excel 檔案。

四、輸出欄位定義 (30 欄) (精修)
1.  **ERP**:"待匯"，此格有下拉式選單。
2.  **GD**: 留空。
3.  **平台前導**:留空。
4.  **寄件廠商**：來自 AI 提取的 `寄件廠商`。
5.  **暫代條碼**：留空。
6.  **型號**：來自 AI 提取的 `國際條碼`。
7.  **貨號**：來自 AI 提取的 `貨號`。
8.  **預計發售月份**：來自 AI 提取並由程式正規化為 `YYYYMM`。
9.  **上架日期**：填入今天日期（程式自動填入），格式 `YYYY/MM/DD`。
10.  **結單日期**：以 `YYYY/MM/DD` 輸出；優先使用從檔名解析出的未來日期，並套用上述的「週末調整」規則。
11.  **條碼**：內容同 `型號` 欄位。
12. **品名 (規則更新)**：預設為 AI 提取的原始品名。若系統成功比對到品牌，且該品牌在 `品牌對照資料查詢.xlsx` 的 **D欄** 有設定「顯示名稱」，則此欄位的值會被自動組合為 `D欄顯示名稱 原始品名`。
13. **品牌 (規則更新)**：此欄位由程式自動填入**品牌代碼 (B欄)**。採用多層次邏輯決定（詳見處理流程），優先使用 AI 判斷的品牌，其次為單一品牌檔案的備援品牌，最後為 Excel 公式。
14. **國際條碼**：留空。
15. **起始進價**：來自 AI 提取的 `起始進價`。
16. **建議售價**：來自 AI 提取的 `建議售價`。
17. **廠商**：留空。
18. **類1**：留空。
19. **類2**：留空。
20. **類3**：留空。
21. **類4**：留空。
22. **顏色**：留空。
23. **季別**：留空。
24. **尺1**：固定填入 `F`。
25. **尺寸名稱**：固定填入 `F`。
26. **特價**：留空。
27. **批價**：留空。
28. **建檔**：留空。
29. **備註**：來自 AI 提取的 `備註`。
30. **規格**：留空。

四之一、附加規格（Google Sheet 與比對規則）

1.  Google Sheet 上傳與授權
    - 程式支援將最終資料直接寫入 Google Sheet（Append 新列）。
    - 授權採用 Service Account 金鑰（JSON 檔案），程式以該金鑰建立憑證並存取 Sheets API。
    - 使用者需將該 Service Account 的 email（在金鑰 JSON 中可見）加入目標 Google Sheet 的編輯者名單，否則無法寫入。

2.  寄件廠商比對優先順序與多值支援
    - 新增規則：在處理每個來源檔案時，程式會先於「檔名」中嘗試尋找是否包含任一已載入的寄件廠商名稱（大小寫不敏感，包含關鍵字即可視為命中）。
    - **[修正]** 若檔名命中任一寄件廠商，程式會將此命中值視為**最終結果**。即使後續 AI 分析的內容沒有找到廠商，此命中值也會被**強制覆寫**，確保檔名匹配的最高優先級。
    - 若檔名未命中，才會在檔案內容中搜尋寄件廠商：程式會把 `廠商名單.xlsx` 中的每個儲存格展開（以逗號 "," 分隔），把所有子項平鋪成一個比對清單；只要內容中任一子項被匹配到，即視為命中該寄件廠商。

3.  在輸出表寫入公式（品牌 / 廠商）
    - 在輸出到 Google Sheet 或 Excel 時，程式不再把「品牌」與「廠商」寫死為文字，而是寫入公式，讓試算表端自動計算代碼：
      - M 欄（品牌）：公式會先從同列 L 欄（品名）取出 '|' 左側作為品牌關鍵字（若無 '|' 則取整個品名），再於同一試算表的工作表 `品牌對照資料查詢` 的 C 欄比對，回傳對應的 A 欄（品牌代號）。找不到則回傳空字串。示例公式：
        =IFERROR(INDEX('品牌對照資料查詢'!A:A, MATCH(IFERROR(TRIM(LEFT(L3,FIND("|",L3)-1)),TRIM(L3)), '品牌對照資料查詢'!C:C, 0)), "")
      - Q 欄（廠商）：公式會以同列 D 欄（寄件廠商）去 `廠商基本資料` 工作表的 D 欄做精準 MATCH，回傳 A 欄（廠商代碼）。找不到則回傳空字串。示例公式：
        =IFERROR(INDEX('廠商基本資料'!A:A, MATCH(D3, '廠商基本資料'!D:D, 0)), "")
    - 公式設計兼容 Excel 與 Google Sheets（使用 INDEX / MATCH / IFERROR 等通用函數）。

4.  試算表資料起始列
    - 目標 Google Sheet 的第 1 列保留為欄位標題，第 2 列保留為欄位說明（程式不會覆寫前兩列）。
    - 實際資料從第 3 列開始寫入（程式在生成公式時會以第 3 列為第一筆資料的參照位址，例如 L3 / D3）。


五、GUI 操作流程（已更新）
1.  **啟動程式**：顯示主視窗，左上角有 API Key 輸入欄位。
2.  **匯入檔案**：使用者按下「匯入檔案」，可選擇 1 到 10 個 `.xlsx` 或 `.xls` 檔案；匯入後 GUI 的清單只會顯示檔名（不顯示完整路徑），以便確認選擇。
3.  **指定輸出（在按開始時進行）**：使用者在確認匯入檔案後按「開始處理」，程式會在此時跳出另存新檔（save-as）對話框，讓使用者命名並指定輸出位置；若使用者取消，處理中止。
4.  **執行處理**：程式在背景執行 AI 提取與格式化流程。GUI 顯示處理中 log，按鈕被鎖定避免重複啟動。
5.  **完成提示**：處理完成，跳出訊息告知輸出路徑，並解除按鈕鎖定。

六、錯誤處理與提醒
- 未選擇來源檔或取消選擇：流程終止，GUI 提示使用者。
- 在按「開始處理」時若取消儲存輸出檔：流程終止，GUI 提示使用者。
- `廠商名單.xlsx` 不存在：啟動時記錄警告，但仍可繼續執行（寄件廠商欄位將為空）。
- AI API 金鑰無效或網路問題：在 GUI 顯示錯誤訊息，並中止處理。
- AI 回傳資料格式錯誤：在 GUI 顯示錯誤；若啟用中介 `raw_data.json`，可由使用者檢視該檔檢查問題。

七、安全與隱私
- 程式執行需要設定 OpenAI API 金鑰。建議使用設定檔（程式以 `config.json` 暫存 API Key）或環境變數管理，避免硬編碼。
- 所有檔案處理均在本地進行；僅在 AI 提取階段會把 CSV 內容傳送至 OpenAI API（如使用者提供金鑰）。

八、檔案與程式結構（目前實作）
- `main.py`：GUI 啟動與總控；`process_files_main(app, api_key, input_files, output_file)` 由 GUI 呼叫。
- `gui.py`：tkinter 介面，負責匯入檔案、顯示檔名清單、要求使用者在開始時指定輸出檔名、顯示 log。
- `data_processor.py`：負責 Excel 轉 CSV、日期與月份正規化、結單日期調整與最終 Excel 輸出。
- `ai_api.py`：與 AI（OpenAI / Gemini）互動的封裝函式。
- `config.json`：用於儲存 API Key（由 GUI 管理）。
