以下是「究極進化版 ERP 合併標準化工具」的規格書。內容涵蓋目標、輸入/輸出、欄位定義、流程、GUI 互動、錯誤處理、相依環境與可擴充性。

一、專案概要
- 名稱：究極進化版 ERP 合併標準化工具
- 目的：讓使用者透過 GUI 介面，選擇多份 Excel 訂單檔案，由 AI 進行智慧資料提取，再由 Python 程式將提取後的資料精準對映，最終輸出為統一格式的 Excel 檔案，供後續上傳 ERP 系統。
- 執行環境：Windows（優先）、Python 3.10+
- GUI：tkinter
- 主要套件：pandas、openpyxl、openai、tkinter（標準庫）

二、輸入與輸出
1) 輸入
- **來源檔案**：
  - 檔案型態：.xlsx 或 .xls
  - 檔案數量：使用者一次可選擇 1 至 10 份檔案（程式限制最多 10）。
  - 工作表：每份來源檔僅讀取第一個 Sheet 的全部內容，不進行任何預處理。
- **設定檔案**：
  - `廠商名單.xlsx`：與主程式放在同一目錄，包含一個名為「寄件廠商」的欄位，用於讓 AI 精準匹配。

2) 輸出
- **中介資料（除錯用，可關閉）**：
  - `raw_data.json`：由 AI 提取並經過結構化處理後的 JSON。注意：目前程式預設不主動儲存中介 JSON（已註解），可在偵錯時啟用以檢視 AI 回傳。
- **最終產出**：
  - 檔案型態：Excel .xlsx
  - 檔名：預設 `究極進化版用.xlsx`（使用者可在 GUI 的「開始處理」時指定儲存路徑與檔名）。
  - 工作表：單一 Sheet，名稱 `ERP`
  - 欄位結構：固定 27 欄，順序與名稱必須嚴格符合規定。

三、處理流程 (兩階段)

**第一階段：AI 資料提取**
此階段的目標是讓 AI 從原始、非結構化的 Excel 資料中，辨識並提取出有用的資訊。

1.  **讀取資料**：Python 程式讀取使用者選擇的 Excel 檔案，將其完整內容轉換為 CSV 格式以供 AI 做解析。
2.  **準備提示 (Prompt)**：程式將結合 CSV 內容與 `廠商名單.xlsx`，產生一個詳細指令給 AI，要求提取下列欄位：
    - `寄件廠商`：從 `廠商名單.xlsx` 找完全符合的廠商名稱。
    - `國際條碼`：關鍵字 ['國際條碼', 'jan code', '條碼']。
    - `貨號`：關鍵字 ['sku', '貨號', '商品貨號']。
    - `品名`：關鍵字 ['品名', '商品名', '品項', '商品', '中文品名']。
    - `結單日期`：優先從檔名擷取（例如檔名開頭為 `0126結單`，則擷取 `0126`）；若檔名無法擷取，再於內容中搜尋關鍵字 ['結單日', '結單日期', '訂購截止日', '訂單截止日', '預定截止日', '最後回單日']。
    - `預計發售月份`：關鍵字 ['發售日', '預定到貨', '預計上市日', '發貨日']。
    - `備註`：關鍵字 ['備註', '備考', '附註', '註']。
    - `起始進價`：關鍵字 ['東海成本']。
    - `建議售價`：關鍵字 ['東海售價']。
3.  **資料篩選（由 AI 執行）**：AI 在提取過程中會過濾掉任何在 `起始進價` 或 `建議售價` 欄位缺值的商品。
4.  **AI 回傳格式**：AI 應回傳結構化 JSON，包含 `global_info` 與 `products` 陣列，供第二階段使用。

**第二階段：Python 格式化與輸出**
此階段的目標是讀取 AI 回傳的結構化 JSON，將資料填入 30 欄 ERP 格式，並在輸出前做必要的格式正規化（特別是日期與月份格式）。

1.  **讀取 JSON**：程式讀取 AI 回傳的 JSON（若啟用 debug，會儲存為 `raw_data.json`）。
2.  **欄位對映**：將 JSON 中的欄位對應填入 30 個 ERP 欄位。
3.  **日期與月份正規化**：
    - `預計發售月份`：會正規化為 `YYYYMM`（例如 `202511`）。不論原始儲存格為 Excel 日期（Timestamp）、或顯示為 `2025.11`、或字串含時間 `2025-11-01 00:00:00`，程式會先以 `pandas.to_datetime` 解析，再取年與月份。
    - `上架日期`：自動填入執行當天日期，格式 `YYYY/MM/DD`。
    - `結單日期`：程式會以 `YYYY/MM/DD` 格式輸出；當來源為檔名（如 `0126`）時，會選擇「最接近且大於今天」的那個日期（可能是當年度或下一年度），若 AI 也回傳結單日期，且檔名解析成功，檔名日期會優先覆蓋 AI 的值。
    - `結單日期` 的最終調整規則（週末處理）：
        1. 如果原始結單日期為週末（週六/週日），先向前移動到最近的前一個平日（週一到週五），再往前減 1 天，最後若結果仍非平日則再向前移到前一個平日。
        2. 若原始結單日期為平日，則先往前減 1 天；如果該結果落在週末，則再往前移到最近的平日。
       （備註：目前只把週末視為「非上班日」，未納入台灣國定假日。如需完整國定假日支援，可引入 `holidays` 或 `workalendar` 等套件並在規則中考量。）
4.  **合併輸出**：將所有處理後的商品資料合併成一個 DataFrame，並輸出為 `ERP` 工作表的 Excel 檔案。

四、輸出欄位定義 (30 欄)
1.  **ERP**:"待匯"，此格有下拉式選單。
2.  **GD**: 留空。
3.  **平台前導**:留空。
4.  **寄件廠商**：來自 AI 提取的 `寄件廠商`。
5.  **暫代條碼**：留空。
6.  **型號**：來自 AI 提取的 `國際條碼`。
7.  **貨號**：來自 AI 提取的 `貨號`。
8.  **預計發售月份**：來自 AI 提取並由程式正規化為 `YYYYMM`。
9.  **上架日期**：填入今天日期（程式自動填入），格式 `YYYY/MM/DD`。
10.  **結單日期**：以 `YYYY/MM/DD` 輸出；優先使用從檔名解析出的未來日期，並套用上述的「週末調整」規則。
11.  **條碼**：內容同 `型號` 欄位。
12.  **品名**：來自 AI 提取的 `品名`。
13. **品牌**：留空。
14. **國際條碼**：留空。
15. **起始進價**：來自 AI 提取的 `起始進價`。
16. **建議售價**：來自 AI 提取的 `建議售價`。
17. **廠商**：留空。
18. **類1**：留空。
19. **類2**：留空。
20. **類3**：留空。
21. **類4**：留空。
22. **顏色**：留空。
23. **季別**：留空。
24. **尺1**：固定填入 `F`。
25. **尺寸名稱**：固定填入 `F`。
26. **特價**：留空。
27. **批價**：留空。
28. **建檔**：留空。
29. **備註**：來自 AI 提取的 `備註`。
30. **規格**：留空。

五、GUI 操作流程（已更新）
1.  **啟動程式**：顯示主視窗，左上角有 API Key 輸入欄位。
2.  **匯入檔案**：使用者按下「匯入檔案」，可選擇 1 到 10 個 `.xlsx` 或 `.xls` 檔案；匯入後 GUI 的清單只會顯示檔名（不顯示完整路徑），以便確認選擇。
3.  **指定輸出（在按開始時進行）**：使用者在確認匯入檔案後按「開始處理」，程式會在此時跳出另存新檔（save-as）對話框，讓使用者命名並指定輸出位置；若使用者取消，處理中止。
4.  **執行處理**：程式在背景執行 AI 提取與格式化流程。GUI 顯示處理中 log，按鈕被鎖定避免重複啟動。
5.  **完成提示**：處理完成，跳出訊息告知輸出路徑，並解除按鈕鎖定。

六、錯誤處理與提醒
- 未選擇來源檔或取消選擇：流程終止，GUI 提示使用者。
- 在按「開始處理」時若取消儲存輸出檔：流程終止，GUI 提示使用者。
- `廠商名單.xlsx` 不存在：啟動時記錄警告，但仍可繼續執行（寄件廠商欄位將為空）。
- AI API 金鑰無效或網路問題：在 GUI 顯示錯誤訊息，並中止處理。
- AI 回傳資料格式錯誤：在 GUI 顯示錯誤；若啟用中介 `raw_data.json`，可由使用者檢視該檔檢查問題。

七、安全與隱私
- 程式執行需要設定 OpenAI API 金鑰。建議使用設定檔（程式以 `config.json` 暫存 API Key）或環境變數管理，避免硬編碼。
- 所有檔案處理均在本地進行；僅在 AI 提取階段會把 CSV 內容傳送至 OpenAI API（如使用者提供金鑰）。

八、檔案與程式結構（目前實作）
- `main.py`：GUI 啟動與總控；`process_files_main(app, api_key, input_files, output_file)` 由 GUI 呼叫。
- `gui.py`：tkinter 介面，負責匯入檔案、顯示檔名清單、要求使用者在開始時指定輸出檔名、顯示 log。
- `data_processor.py`：負責 Excel 轉 CSV、日期與月份正規化、結單日期調整與最終 Excel 輸出。
- `ai_api.py`：與 AI（OpenAI / Gemini）互動的封裝函式。
- `config.json`：用於儲存 API Key（由 GUI 管理）。
