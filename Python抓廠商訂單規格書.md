以下是「究極進化版 ERP 合併標準化工具」的規格書。內容涵蓋目標、輸入/輸出、欄位定義、流程、GUI 互動、錯誤處理、相依環境與可擴充性。

一、專案概要
- 名稱：究極進化版 ERP 合併標準化工具
- 目的：讓使用者透過 GUI 介面，選擇多份 Excel 訂單檔案，由 AI 進行智慧資料提取，再由 Python 程式將提取後的資料精準對映，最終輸出為統一格式的 Excel 檔案，供後續上傳 ERP 系統。
- 執行環境：Windows（優先）、Python 3.10+
- GUI：tkinter
- 主要套件：pandas、openpyxl、openai、tkinter（標準庫）

二、輸入與輸出
1) 輸入
- **來源檔案**：
  - 檔案型態：.xlsx 或 .xls
  - 檔案數量：使用者一次可選擇 1 至 5 份檔案。
  - 工作表：每份來源檔僅讀取第一個 Sheet 的全部內容，不進行任何預處理。
- **設定檔案**：
  - `廠商名單.xlsx`：與主程式放在同一目錄，包含一個名為「寄件廠商」的欄位，用於讓 AI 精準匹配。

2) 輸出
- **中介資料**：
  - `raw_data.json`：由 AI 提取並經過結構化處理後的 JSON 檔案。每個來源檔會產生一個對應的 JSON 檔（例如 `input_1_raw_data.json`），存於輸出目錄。
- **最終產出**：
  - 檔案型態：Excel .xlsx
  - 檔名：預設「究極進化版用.xlsx」（可由使用者在 GUI 調整）
  - 工作表：單一 Sheet，名稱「ERP」
  - 欄位結構：固定 27 欄，順序與名稱必須嚴格符合規定。

三、處理流程 (兩階段)

**第一階段：AI 資料提取**
此階段的目標是讓 AI 從原始、非結構化的 Excel 資料中，辨識並提取出有用的資訊。

1.  **讀取資料**：Python 程式讀取使用者選擇的 Excel 檔案，將其完整內容轉換為 CSV 格式。
2.  **準備提示 (Prompt)**：程式將結合 JSON 資料和 `廠商名單.xlsx` 中的廠商列表，產生一個詳細的指令，要求 AI 提取以下欄位：
    -   `寄件廠商`: 根據提供的廠商名單，在 Excel 全域尋找完全符合的文字。
    -   `國際條碼`: 關鍵字 ['國際條碼', 'jan code', '條碼']
    -   `貨號`: 關鍵字 ['sku', '貨號', '商品貨號']
    -   `品名`: 關鍵字 ['品名', '商品名', '品項', '商品', '中文品名']
    -   `結單日期`: 關鍵字 ['結單日', '結單日期', '訂購截止日', '訂單截止日', '預定截止日', '最後回單日']
    -   `預計發售月份`: 關鍵字 ['發售日', '預定到貨', '預計上市日', '發貨日']
    -   `備註`: 關鍵字 ['備註', '備考', '附註', '註']
    -   `起始進價`: 關鍵字 ['東海成本']
    -   `建議售價`: 關鍵字 ['東海售價']
3.  **資料篩選 (由 AI 執行)**：AI 在提取過程中，會自動過濾掉「起始進價」或「建議售價」任一欄位沒有值的商品。
4.  **輸出 JSON**：AI 將提取並篩選後的結果，以結構化的 JSON 格式回傳。Python 程式會將此結果儲存為 `raw_data.json`。

**第二階段：Python 格式化與輸出**
此階段的目標是讀取 AI 產生的乾淨 JSON，並將其精準地填入最終的 Excel 格式。

1.  **讀取 JSON**：程式讀取第一階段產生的 `raw_data.json` 檔案。
2.  **欄位對映**：逐一將 JSON 中的資料填入指定的 27 個 ERP 欄位。
3.  **合併資料**：如果使用者選擇了多個檔案，程式會將所有處理完的資料合併成一個列表。
4.  **產生 Excel**：將最終結果寫入一個新的 Excel 檔案。

四、輸出欄位定義 (27 欄)
1.  **寄件廠商**：來自 AI 提取的 `寄件廠商`。
2.  **暫代條碼**：留空。
3.  **型號**：來自 AI 提取的 `國際條碼`。
4.  **貨號**：來自 AI 提取的 `貨號`。
5.  **預計發售月份**：來自 AI 提取的 `預計發售月份`，並由程式確保格式為 `YYYYMM`。
6.  **上架日期**：留空。
7.  **結單日期**：來自 AI 提取的 `結單日期`，並由程式確保格式為 `YYYY/MM/DD`。
8.  **條碼**：內容同 `型號` 欄位。
9.  **品名**：來自 AI 提取的 `品名`。
10. **品牌**：留空。
11. **國際條碼**：留空。
12. **起始進價**：來自 AI 提取的 `起始進價`。
13. **建議售價**：來自 AI 提取的 `建議售價`。
14. **廠商**：留空。
15. **類1**：留空。
16. **類2**：留空。
17. **類3**：留空。
18. **類4**：留空。
19. **顏色**：留空。
20. **季別**：留空。
21. **尺1**：固定填入 "F"。
22. **尺寸名稱**：固定填入 "F"。
23. **特價**：留空。
24. **批價**：留空。
25. **建檔**：留空。
26. **備註**：來自 AI 提取的 `備註`。
27. **規格**：留空。

五、GUI 操作流程
1.  **啟動程式**：顯示主視窗。
2.  **選擇檔案**：點擊按鈕後，跳出檔案選擇對話框，使用者可選擇 1 至 5 個 `.xlsx` 或 `.xls` 檔案。
3.  **指定輸出**：選擇來源檔後，立即跳出另存新檔對話框，讓使用者指定輸出位置與檔名（預設為 `究極進化版用.xlsx`）。
4.  **執行處理**：程式在背景執行上述兩階段流程。GUI 介面應顯示處理中狀態，並印出 log。
5.  **完成提示**：處理完成後，跳出訊息框，告知使用者已成功產出檔案，並顯示輸出路徑。

六、錯誤處理與提醒
- 未選擇來源檔或取消選擇：流程終止，GUI 提示使用者。
- 未指定輸出檔或取消儲存：流程終止，GUI 提示使用者。
- `廠商名單.xlsx` 不存在：啟動時提示警告，但仍可繼續執行（寄件廠商欄位將為空）。
- AI API 金鑰無效或網路問題：在 GUI 顯示明確的錯誤訊息。
- AI 回傳資料格式錯誤：在 GUI 顯示錯誤，並提示使用者檢查 `raw_data.json`。

七、安全與隱私
- 程式執行需要設定 OpenAI API 金鑰。建議使用環境變數或設定檔進行管理，避免寫死在程式碼中。
- 所有檔案處理均在本地進行，僅在第一階段會將 Excel 內容傳送至 OpenAI API。

八、檔案與程式結構 (建議)
- **`main.py`**：包含 `tkinter` GUI 的所有程式碼、流程控制（呼叫其他模組）。
- **`ai_processor.py`**：負責與 OpenAI API 互動，包含建立 Prompt、發送請求、接收回應等功能。
- **`excel_formatter.py`**：負責第二階段的處理，讀取 AI 的 JSON 結果，並使用 `pandas` 將其轉換及輸出為最終的 Excel 檔案。
- **`config.py` (可選)**：用於管理 API 金鑰或其他設定。
